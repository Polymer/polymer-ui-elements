<!--
Copyright 2013 The Toolkitchen Authors. All rights reserved.
Use of this source code is governed by a BSD-style
license that can be found in the LICENSE file.
-->

<link rel="import" href="../../toolkit-ui/elements/g-jsonp.html">
<link rel="import" href="../../toolkit-ui/elements/g-ajax.html">
<link rel="import" href="uxa-stock-legend-item.html">

<element name="uxa-stock" attributes="symbols autoupdate">
	<link rel="stylesheet" href="css/uxa-stock.css">

  <template>

    <div id="widget-title">Market Summary</div>

    <template repeat="{{symbols}}">
      <x-stock-legend-item id="legend-{{name}}" label="{{name}}" data="{{jsonpResponse}}" color="{{color}}"></x-stock-legend-item>
    </template>

    <template repeat="{{symbols}}">
      <g-jsonp id="jsonp" on-response="jsonpResponseHandler" name="{{name}}" symbol="{{symbol}}" url="https://clients1.google.com/finance/info?q={{symbol}}&client=ob&infotype=infoonebox&callback="></g-jsonp>
    </template>

    <div class="more">
      <div id="chart">
        <div id="bg"></div>
        <div id="data"></div>
      </div>
    </div>

    <g-ajax id="ajax" on-response="ajaxResponse" handleAs="json" auto="true" url="../elements/uxa-stock-test-data.json"></g-ajax>
  </template>
  <script>
    Toolkit.register(this, {
      symbols: '',
      updateinterval: 60000,
      jsonpResponse:null,
      ready: function() {
        var symbols = this.symbols.split(',');
        this.symbols = [];
        for(var i=0;i<symbols.length;i++){
          var symbol = {
            'name': symbols[i].replace('.', ''),
            'symbol': symbols[i],
            'jsonpResponse': null
          }
          this.symbols.push(symbol);
        }
      },
      symbolsChanged: function() {
        console.log('symbolsChanged');
        console.log(this.symbols);
      },
      autoupdateChanged: function() {
        console.log('autoupdateChanged');
        if (this.autoupdate) {
          this.intervalId = setInterval(this.go.bind(this), this.updateinterval);
        } else if (this.intervalId) {
          clearInterval(this.intervalId);
        }
      },
      ajaxResponse: function(e, res, sender){
        console.log('ajaxResponseHandler');
        this.load_chart(res.response);
      },
      jsonpResponseHandler: function(e, res, sender){
        var symbol = sender.getAttribute('symbol');
        var name = sender.getAttribute('name');
        console.log('jsonpResponse');

        for(var i=0;i<this.symbols.length;i++){
          if(this.symbols[i].name == name) {
            this.symbols[i].jsonpResponse = res.response[0];
            return;
          }
        }
      },
      load_chart: function(json){
        console.log(json);

        data = new google.visualization.DataTable();
        data.addColumn('string', 'Time');

        for(var i=0;i<this.symbols.length;i++){
          data.addColumn('number', this.symbols[i].name);
        }

        var rows = [
          ['9:30'],
          ['10am'],
          ['11'],
          ['12'],
          ['1'],
          ['2'],
          ['3'],
          ['4pm']
        ];

        for(var i=0;i<this.symbols.length;i++){
          var symbol = this.symbols[i].symbol;
          var row = [];
          for(var x=0; x<8;x++) {
            var time = rows[x][0];
            var value = parseFloat(json.results[symbol][time]['percent']);
            rows[x].push(value);
          }
        }
        data.addRows(rows);

        var options = {
          titlePosition: 'none',
          colors: ['#4E8DF5', '#DB4743', '#F4C138'],
          enableInteractivity: true,
          fontSize: 12,
          lineWidth: 1,
          interpolateNulls: false,
          animation:{
            duration: 1000,
            easing: 'out',
          },
          fontName: 'HelveticaNeue',
          backgroundColor: {
            fill: 'transparent',
          },
          chartArea:{
            left:0,
            top:0,
            width: 300,
            height: 120
          },
          hAxis: {
            viewWindowMode: 'explicit',
            allowContainerBoundaryTextCufoff: true,
            viewWindow: {
              min: 1,
              max: 8
            }
          },
          vAxis: {
            baselineColor: '#999999',
            gridlines: {
              color: '#E6E6E6'
            }
          },
          legend: {
            position: 'none'
          }
        };


        for(var i=0;i<this.symbols.length;i++){
          this.symbols[i].color = options.colors[i];
        }

        var chart = new google.visualization.LineChart(this.$.data);
        chart.draw(data, options);
      }
    });
  </script>
</element>
